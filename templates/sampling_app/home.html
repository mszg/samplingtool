{% extends "base.html" %}
{% block title %}RefSetCollect â€” Home{% endblock %}

{% block content %}
<h1 class="mb-4">RefSetCollect</h1>


<form id="sampling-form" method="POST" class="mb-4">
    {% csrf_token %}

    <div class="mb-3">
        <label for="taxon" class="form-label">Taxon (query)</label>
        <input
            type="text"
            id="taxon"
            name="taxon"
            class="form-control"
            placeholder="Recommended: numeric TaxID (e.g., 562 for E. coli)"
            required
        >
        <div class="form-text">
            Tip: Use a numeric NCBI TaxID for fastest and deterministic results. Names can be ambiguous.
        </div>
    </div>

    <div class="mb-3">
        <label for="rank" class="form-label">Rank</label>
        <select id="rank" name="rank" class="form-select">
            <option value="SPECIES" selected>SPECIES</option>
            <option value="GENUS">GENUS</option>
            <option value="FAMILY">FAMILY</option>
            <option value="ORDER">ORDER</option>
            <option value="CLASS">CLASS</option>
            <option value="PHYLUM">PHYLUM</option>
            <option value="KINGDOM">KINGDOM</option>
        </select>
        <div class="form-text">
            Target rank for sampling. Higher ranks (e.g., FAMILY/ORDER) may take longer.
        </div>
    </div>

    <div class="mb-3">
        <label for="genomes" class="form-label">Genomes per taxon</label>
        <input type="number" id="genomes" name="genomes" class="form-control" value="1" min="1">
        <div class="form-text">
            Recommended for testing: 1. Increasing this increases output size and can increase runtime.
        </div>
    </div>

    <details class="mb-3">
        <summary class="mb-2">Advanced options</summary>

        <div class="row g-3">
            <div class="col-md-6">
                <label for="tree" class="form-label">Tree</label>
                <select id="tree" name="tree" class="form-select">
                    <option value="basic" selected>basic (recommended, faster)</option>
                    <option value="phantom">phantom (slower; may add minutes)</option>
                </select>
                <div class="form-text">
                    basic is faster. phantom can take significantly longer due to phantom node insertion.
                </div>
            </div>

            <div class="col-md-6">
                <label for="method" class="form-label">Method</label>
                <select id="method" name="method" class="form-select">
                    <option value="DFS" selected>DFS</option>
                    <option value="list">list</option>
                    <option value="bisect">bisect</option>
                    <option value="sibling">sibling</option>
                </select>
            </div>

            <div class="col-md-6">
                <label for="min_assembly_level" class="form-label">Min assembly level (optional)</label>
                <select id="min_assembly_level" name="min_assembly_level" class="form-select">
                    <option value="" selected>(none)</option>
                    <option value="CONTIG">CONTIG</option>
                    <option value="SCAFFOLD">SCAFFOLD</option>
                    <option value="CHROMOSOME">CHROMOSOME</option>
                    <option value="COMPLETE GENOME">COMPLETE GENOME</option>
                </select>
            </div>

            <div class="col-md-6">
                <label for="seed" class="form-label">Random seed (optional)</label>
                <input type="text" id="seed" name="seed" class="form-control" placeholder="e.g. 123">
                <div class="form-text">Set for reproducible sampling.</div>
            </div>

            <div class="col-12">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="prefer_reference" name="prefer_reference">
                    <label class="form-check-label" for="prefer_reference">
                        Prefer reference genomes (if available)
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="prefer_higher_level" name="prefer_higher_level">
                    <label class="form-check-label" for="prefer_higher_level">
                        Prefer higher assembly level (if available)
                    </label>
                </div>
            </div>

            <div class="col-12">
                <label for="exclude_names" class="form-label">Exclude names (one per line)</label>
                <textarea id="exclude_names" name="exclude_names" class="form-control" rows="3"
                          placeholder="e.g. Homo sapiens"></textarea>
            </div>

            <div class="col-12">
                <label for="exclude_taxids" class="form-label">Exclude TaxIDs (one per line)</label>
                <textarea id="exclude_taxids" name="exclude_taxids" class="form-control" rows="3"
                          placeholder="e.g. 9606"></textarea>
            </div>
        </div>
    </details>

    <button type="submit" class="btn btn-primary w-100" id="run-btn">Submit</button>
</form>

<hr class="my-4">

<div class="mb-2 fw-semibold">Progress</div>
<div class="progress" style="height: 18px;">
    <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
</div>
<div id="progress-msg" class="text-muted mt-2">Waiting for input..</div>

<div id="result-box" class="alert alert-success mt-4" style="display:none;">
    <div class="fw-semibold mb-2">Sampling finished successfully.</div>
    <a id="download-link" href="#" target="_blank" class="btn btn-success btn-sm">
        Download results report (TXT)
    </a>
</div>

<div id="report-section" class="mt-4" style="display:none;">
    <div class="fw-semibold mb-2">Results report</div>
    <pre id="report-text" class="p-3 border rounded" style="white-space: pre-wrap;"></pre>

    <details class="mt-3">
        <summary>Debug details (cmd/stdout/stderr)</summary>
        <div class="mt-2">
            <div class="fw-semibold">Command</div>
            <pre id="debug-cmd" class="p-2 border rounded" style="white-space: pre-wrap;"></pre>

            <div class="fw-semibold mt-3">Stdout</div>
            <pre id="debug-stdout" class="p-2 border rounded" style="white-space: pre-wrap;"></pre>

            <div class="fw-semibold mt-3">Stderr</div>
            <pre id="debug-stderr" class="p-2 border rounded" style="white-space: pre-wrap;"></pre>
        </div>
    </details>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function() {
    const form = document.getElementById("sampling-form");
    const runBtn = document.getElementById("run-btn");

    const progressBar = document.getElementById("progress-bar");
    const progressMsg = document.getElementById("progress-msg");

    const resultBox = document.getElementById("result-box");
    const downloadLink = document.getElementById("download-link");

    const reportSection = document.getElementById("report-section");
    const reportText = document.getElementById("report-text");

    const debugCmd = document.getElementById("debug-cmd");
    const debugStdout = document.getElementById("debug-stdout");
    const debugStderr = document.getElementById("debug-stderr");

    let pollTimer = null;
    let activeJobId = null;

    function setProgress(pct, msg) {
        const clamped = Math.max(0, Math.min(100, Number(pct || 0)));
        progressBar.style.width = clamped + "%";
        progressBar.textContent = clamped + "%";
        progressMsg.textContent = msg || "";
    }

    function resetUI() {
        setProgress(0, "Submitting job...");
        resultBox.style.display = "none";
        reportSection.style.display = "none";
        downloadLink.href = "#";
        reportText.textContent = "";
        debugCmd.textContent = "";
        debugStdout.textContent = "";
        debugStderr.textContent = "";
    }

    async function fetchJson(url) {
        const r = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
        let data = null;
        try { data = await r.json(); } catch (e) {}
        return { ok: r.ok, status: r.status, data };
    }

    async function poll(jobId) {
        // Progress
        const prog = await fetchJson(`/progress/${jobId}/`);
        if (prog.ok && prog.data) {
            setProgress(prog.data.percent, prog.data.message);
        }

        // Result
        const res = await fetchJson(`/result/${jobId}/`);
        if (!res.ok) {
            // If still running, Django returns 202 with {"status":"running"} in our implementation
            // Some setups may treat that as ok=false, so handle gracefully
        }

        if (res.data && res.data.status === "done") {
            clearInterval(pollTimer);
            pollTimer = null;
            runBtn.disabled = false;

            // force 100% UI
            setProgress(100, "Done.");

            resultBox.style.display = "block";
            if (res.data.report_download_url) {
                downloadLink.href = res.data.report_download_url;
            }

            reportSection.style.display = "block";
            reportText.textContent = res.data.report_text || "(No report text available.)";

            debugCmd.textContent = Array.isArray(res.data.cmd) ? res.data.cmd.join(" ") : (res.data.cmd || "");
            debugStdout.textContent = res.data.stdout || "";
            debugStderr.textContent = res.data.stderr || "";
            return;
        }

        if (res.data && res.data.status === "failed") {
            clearInterval(pollTimer);
            pollTimer = null;
            runBtn.disabled = false;

            setProgress(100, "Failed.");
            reportSection.style.display = "block";
            reportText.textContent = res.data.error || "Sampling failed.";

            debugCmd.textContent = Array.isArray(res.data.cmd) ? res.data.cmd.join(" ") : (res.data.cmd || "");
            debugStdout.textContent = res.data.stdout || "";
            debugStderr.textContent = res.data.stderr || "";
            return;
        }
    }

    form.addEventListener("submit", async function(e) {
        e.preventDefault();
        resetUI();
        runBtn.disabled = true;

        const formData = new FormData(form);

        const r = await fetch("{% url 'run_sampling' %}", {
            method: "POST",
            body: formData
        });

        let data = null;
        try { data = await r.json(); } catch (err) {}

        if (!r.ok) {
            runBtn.disabled = false;
            setProgress(100, "Failed.");
            const msg = (data && (data.error || data.message)) ? (data.error || data.message) : "Request failed.";
            progressMsg.textContent = msg;
            return;
        }

        activeJobId = data.job_id;
        setProgress(10, "Job started. Waiting for progress...");
        pollTimer = setInterval(() => poll(activeJobId), 1500);
    });
})();
</script>
{% endblock %}
